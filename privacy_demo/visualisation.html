<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Poli - Privacy Policy visualiser</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <style>
      body {
          background-color: #f0f2f5;
          font-family: 'Roboto', sans-serif;
      }
      .node rect {
          fill: #555;
          stroke: #fff;
          stroke-width: 2px;
      }
      .node text {
          font: 12px 'Roboto', sans-serif;
          pointer-events: none;
      }
      .highlighted {
          background-color: #f3db62;
      }
      .container {
          margin-top: 20px;
      }
      #textContainer {
          width: 100%;
          height: 500px;
          overflow: auto;
          border: 1px solid #e0e0e0;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
          border-radius: 8px;
          padding: 15px;
          background-color: #ffffff;
          font-size: 15px;
          color: #333;
          line-height: 1.6;
      }
      select.form-control {
          border-radius: 8px;
          box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      }
  </style>
</head>
<body>
<div class="container">
    <h1>Poli - Privacy Policy visualiser</h1>
</div>
<div class="container">
    <div class="row">
        <!-- Left column: File selector and text box -->
        <div class="col-sm-4">
            <!-- File Selector Section -->
            <div id="file-selector" style="margin-bottom: 15px;">
                <select id="jsonSelector" class="form-control">
                    <option value="Google.json">Google</option>
                    <option value="TikTok.json">TikTok</option>
                    <option value="CapCut.json">CapCut</option>
                    <option value="OpenAI.json">OpenAI</option>
                    <option value="Temu.json">Temu</option>
                </select>
            </div>
            <div id="dataset_folder"></div>
            <div id="textContainer"></div>
        </div>
        <!-- Right column: Visualization -->
        <div class="col-sm-8">
            <!-- The D3-generated SVG will now include the column headers -->
            <div id="svg_container_1" align="center"></div>
            <!-- Rights and responsibilities section -->
            <div id="svg_container_2">
                <div class="col-sm-6">
                    <div align="left"><h3>Your rights:</h3></div>
                    <div id="svg_container_2a"></div>
                </div>
                <div class="col-sm-6">
                    <div align="left"><h3>Your responsibilities:</h3></div>
                    <div id="svg_container_2b"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- jQuery and Bootstrap JS -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
<!-- D3 and Sankey -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js"></script>
<script>
    const margin = {top: 30, right: 50, bottom: 10, left: 50},
          width = 960 - margin.left - margin.right,
          height = window.innerHeight * 0.6 - margin.top - margin.bottom,
          bar_margin_X = 400,
          bar_width = 20,
          bar_max_height = height,
          buttons_containers_height = window.innerHeight * 0.2;

    function resizeTextContainer(newWidth, newHeight) {
        const container = document.getElementById('textContainer');
        container.style.height = newHeight + 'px';
    }
    resizeTextContainer(300, height + buttons_containers_height);

    // Function to clear existing visualizations
    function clearVisualisation() {
        d3.select("#svg_container_1").html("");
        d3.select("#svg_container_2a").html("");
        d3.select("#svg_container_2b").html("");
        d3.select("#textContainer").html("");
    }

    // Function to load and draw visualization from a given JSON file
    function loadVisualisation(data_name) {
        clearVisualisation();
        d3.json(data_name).then(data => {
            // Create main SVG container
            const svg = d3.select("#svg_container_1")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Add column headers as part of the D3 visualization
            // The columns start at: 0, bar_margin_X*0.66, bar_margin_X*0.66*2, and bar_margin_X*0.66*3
            // We assume a column width of bar_margin_X*0.66 and center the text within each column.
            const columnHeaders = [
                { text: "Data collected", x: 0 - bar_margin_X * 0.33 },
                { text: "Purpose of collection", x: bar_margin_X * 0.33 },
                { text: "Purpose of sharing", x: bar_margin_X * 0.33 * 3 },
                { text: "With whom shared", x: bar_margin_X * 0.33 * 5 }
            ];
            const columnWidth = bar_margin_X * 0.66; // Approximate width of each column
            svg.selectAll(".columnHeader")
                .data(columnHeaders)
                .enter()
                .append("text")
                .attr("class", "columnHeader")
                .attr("x", d => d.x + columnWidth / 2)
                .attr("y", -15)  // Adjust this value to position vertically
                .attr("text-anchor", "middle")
                .style("font-size", "16px")
                .style("font-family", "Roboto, sans-serif")
                .style("fill", "#333")
                .text(d => d.text);

            // Insert the policy text in the text container
            insertText(data["policy_text"]);

            // Draw the hierarchical bars in four columns
            draw_hierarchical_bar(svg, data["data_purpose"], "md", "d", 0);
            draw_hierarchical_bar(svg, [...data["data_purpose"], ...data["purpose_share"]], "mp", "p", bar_margin_X * 0.66);
            draw_hierarchical_bar(svg, [...data["purpose_share"], ...data["share_name"]], "ms", "s", bar_margin_X * 0.66 * 2);
            draw_hierarchical_bar(svg, data["share_name"], "mn", "n", bar_margin_X * 0.66 * 3);

            // Draw connecting lines between columns
            draw_lines(svg, data, "data_purpose", "md", "d", "mp", "p");
            draw_lines(svg, data, "purpose_share", "mp", "p", "ms", "s");
            draw_lines(svg, data, "share_name", "ms", "s", "mn", "n");

            // Generate button boxes for user rights and responsibilities
            generate_button_boxes("#svg_container_2a", data["user_rights"]);
            generate_button_boxes("#svg_container_2b", data["user_responsibilities"]);
        });
    }

    // Automatically load visualization when a new option is selected
    document.getElementById("jsonSelector").addEventListener("change", function() {
        const selectedFile = this.value;
        loadVisualisation(selectedFile);
    });

    // Load initial visualization with default JSON file
    loadVisualisation(document.getElementById("jsonSelector").value);

    function generate_button_boxes(target_container, data) {
        var container = d3.select(target_container);
        container.selectAll("button")
            .data(data)
            .enter()
            .append("button")
            .text(function (d) { return d["n"]; })
            .attr("id", function (d) { return d["n"]; })
            .on("click", function (event, d) {
                handleLineClick(d["r"], d["n"], "btn");
            })
            .style("background-color", "#4CAF50")
            .style("color", "white")
            .style("padding", "10px 20px")
            .style("margin", "5px")
            .style("border", "none")
            .style("border-radius", "5px")
            .style("cursor", "pointer")
            .style("font-size", "16px");
    }

    function insertText(lines) {
        const container = d3.select("#textContainer");
        container.html('');
        lines.forEach(line => {
            container.append('div').text(line);
        });
    }

    let highlightedLineId = null;
    function handleLineClick(lineId, lineName, type) {
        const container = document.getElementById("textContainer");
        const lines = container.getElementsByTagName('div');
        const allSvgLines = d3.selectAll("path");
        const allButtons = d3.selectAll("button");

        if (highlightedLineId === lineId) {
            lines[lineId].classList.remove('highlighted');
            allSvgLines.transition().duration(500).style("stroke-opacity", function () {
                return parseFloat(this.getAttribute("const_opacity"));
            });
            allButtons.transition().duration(500).style("opacity", 1);
            highlightedLineId = null;
        } else {
            if (highlightedLineId !== null && highlightedLineId < lines.length) {
                lines[highlightedLineId].classList.remove('highlighted');
            }
            lines[lineId].classList.add('highlighted');
            allSvgLines.transition().duration(500).style("stroke-opacity", 0.1);
            allButtons.transition().duration(500).style("opacity", 0.3);
            if (type === "line") {
                d3.select("#" + lineName).transition().duration(500).style("stroke-opacity", 1);
            } else {
                d3.select("#" + lineName).transition().duration(500).style("opacity", 1);
            }
            highlightedLineId = lineId;
            scrollToLine(lineId);
        }
    }

    function scrollToLine(lineIndex) {
        const container = document.getElementById("textContainer");
        const lines = container.getElementsByTagName('div');
        if (lineIndex < lines.length) {
            let cumulativeHeight = 0;
            for (let i = 0; i < lineIndex; i++) {
                cumulativeHeight += lines[i].offsetHeight;
            }
            container.scrollTo({
                top: cumulativeHeight,
                behavior: 'smooth'
            });
        }
    }

    function draw_lines(svg, data, line_name, MA, A, MB, B) {
        data[line_name].forEach(line_item => {
            let points = [
                getRectangleCenter(A + "___" + line_item[A]),
                getRectangleCenter(MA + "___" + line_item[MA]),
                getRectangleCenter(MB + "___" + line_item[MB]),
                getRectangleCenter(B + "___" + line_item[B])
            ];
            points[1]["x"] += bar_margin_X / 4;
            points[2]["x"] -= bar_margin_X / 4;
            drawBezierCurve_v2(svg, points, 10, line_item["c"], line_item["o"] + 0.3, line_name + "___" + line_item[A] + "__" + line_item[B], line_item["r"]);
        });
        svg.selectAll('path').each(function () {
            let firstChild = this.parentNode.firstChild;
            if (firstChild) {
                this.parentNode.insertBefore(this, firstChild);
            }
        });

        function drawBezierCurve_v2(svg, points, thickness, color, opacity, id, r) {
            const lineGenerator = d3.line()
                .curve(d3.curveBasis)
                .x(d => d.x)
                .y(d => d.y);
            let existingLine = svg.selectAll('path').filter(function () {
                let currentData = d3.select(this).datum();
                return JSON.stringify(currentData) === JSON.stringify(points);
            });
            if (!existingLine.empty()) {
                let shiftAmount = thickness;
                points = points.map(p => ({x: p.x, y: p.y + shiftAmount}));
            }
            svg.append("path")
                .datum(points)
                .attr("fill", "none")
                .attr("stroke", color)
                .attr("stroke-width", thickness)
                .attr("stroke-opacity", opacity)
                .attr("d", lineGenerator)
                .attr("id", id + "_" + r)
                .attr("policy_idx", r)
                .attr("const_opacity", opacity)
                .on("click", function (event, d) {
                    event.stopPropagation();
                    handleLineClick(r, id + "_" + r, "line");
                });
        }

        function getRectangleCenter(id) {
            const rect = d3.select(`#${id}`);
            if (!rect.empty()) {
                const x = +rect.attr("x");
                const y = +rect.attr("y");
                const width = +rect.attr("width");
                const height = +rect.attr("height");
                return {x: x + width / 2, y: y + height / 2};
            } else {
                console.log("Cannot find " + `#${id}`);
                return null;
            }
        }
    }

    function draw_hierarchical_bar(svg, data, meta, entity, X) {
        let position_margin = bar_width * 1.3;
        let meta_class_length = calculateFrequency(data, meta);
        const singe_meta_bar_height = bar_max_height * 0.8 / data.length;
        const singe_meta_bar_margin = bar_max_height * 0.2 / data.length;
        let meta_bar_end = 0;
        Object.keys(meta_class_length).forEach(meta_item => {
            let current_meta_bar_height = singe_meta_bar_height * meta_class_length[meta_item];
            drawRectangleRound(svg, X, meta_bar_end, meta + "___" + meta_item, "lightgrey", 0.8, current_meta_bar_height, bar_width * 1.6);
            let entites = data.filter(i => i[meta] === meta_item);
            let entity_class_length = calculateFrequency(entites, entity);
            const singe_entity_bar_height = current_meta_bar_height * 0.8 / Object.keys(entity_class_length).length;
            const singe_entity_bar_margin = current_meta_bar_height * 0.2 / Object.keys(entity_class_length).length;
            let entity_bar_end = meta_bar_end;
            Object.keys(entity_class_length).forEach(entity_item => {
                entity_bar_end += singe_entity_bar_margin / 2;
                let current_entity_bar_height = singe_entity_bar_height;
                drawRectangle(svg, X - bar_width + position_margin, entity_bar_end, entity + "___" + entity_item, "darkblue", 1, current_entity_bar_height, bar_width);
                entity_bar_end += current_entity_bar_height + singe_entity_bar_margin / 2;
            });
            meta_bar_end += current_meta_bar_height + singe_meta_bar_margin;
        });

        function calculateFrequency(data, name) {
            const frequency = {};
            data.forEach(item => {
                frequency[item[name]] = (frequency[item[name]] || 0) + 1;
            });
            return frequency;
        }

        function getTextWidth(text, font) {
            var canvas = document.createElement("canvas");
            var context = canvas.getContext("2d");
            context.font = font;
            return context.measureText(text).width;
        }

        function drawRectangle(svg, x, y, id, color, opacity, height, bar_width) {
            svg.append("rect")
                .attr("x", x)
                .attr("y", y)
                .attr("id", id)
                .attr("width", bar_width)
                .attr("height", height)
                .attr("fill", color)
                .attr("opacity", opacity)
                .on("mouseover", handleMouseOver)
                .on("mouseout", handleMouseOut);

            var textBg = svg.append("rect")
                .attr("id", "bg-" + id)
                .attr("rx", 6)
                .attr("ry", 6)
                .attr("fill", "white")
                .style("opacity", 0)
                .style("display", "none");

            var text = svg.append("text")
                .attr("x", x + bar_width / 2)
                .attr("y", y + 15)
                .attr("text-anchor", "middle")
                .attr("alignment-baseline", "middle")
                .text(id.split("___")[1])
                .style("font-size", "14px")
                .style("font-family", "Roboto, sans-serif")
                .style("fill", "lightgray")
                .style("text-shadow", "1px 1px 2px black");

            function handleMouseOver(event, d) {
                text.transition().duration(300).style("font-size", "20px").style("fill", "white");
                var bbox = text.node().getBBox();
                var textContent = text.text();
                var textWidth = getTextWidth(textContent, "14px Roboto");
                textBg.attr("x", bbox.x - textWidth / 2)
                    .attr("y", bbox.y - 5)
                    .attr("width", bbox.width + textWidth)
                    .attr("height", bbox.height + 10)
                    .style("display", "")
                    .transition().duration(300)
                    .style("fill", "black")
                    .style("opacity", 0.8);
                d3.selectAll("text").filter(function () {
                    return this.textContent.includes('___');
                }).raise();
            }

            function handleMouseOut(event, d) {
                textBg.transition().duration(300)
                    .style("opacity", 0)
                    .on("end", function () { textBg.style("display", "none"); });
                text.transition().duration(300).style("font-size", "14px").style("fill", "lightgray");
            }
        }

        function drawRectangleRound(svg, x, y, id, color, opacity, height, bar_width) {
            svg.append("rect")
                .attr("x", x)
                .attr("y", y)
                .attr("id", id)
                .attr("width", bar_width)
                .attr("height", height)
                .attr("fill", color)
                .attr("opacity", opacity)
                .attr("rx", 8)
                .attr("ry", 8)
                .on("mouseover", handleMouseOver)
                .on("mouseout", handleMouseOut);

            var textBg = svg.append("rect")
                .attr("id", "bg-" + id)
                .attr("rx", 6)
                .attr("ry", 6)
                .attr("fill", "white")
                .style("opacity", 0)
                .style("display", "none");

            var text = svg.append("text")
                .attr("x", x + bar_width / 2)
                .attr("y", y)
                .attr("text-anchor", "middle")
                .attr("alignment-baseline", "middle")
                .text(id.split("___")[1])
                .style("font-size", "14px")
                .style("font-family", "Roboto, sans-serif")
                .style("fill", "lightblue")
                .style("text-shadow", "1px 1px 2px black");

            function handleMouseOver(event, d) {
                text.transition().duration(300).style("font-size", "20px").style("fill", "white");
                var bbox = text.node().getBBox();
                var textContent = text.text();
                var textWidth = getTextWidth(textContent, "14px Roboto");
                textBg.attr("x", bbox.x - textWidth / 2)
                    .attr("y", bbox.y - 5)
                    .attr("width", bbox.width + textWidth)
                    .attr("height", bbox.height + 10)
                    .style("display", "")
                    .transition().duration(300)
                    .style("fill", "black")
                    .style("opacity", 0.8);
                d3.selectAll("text").filter(function () {
                    return this.textContent.includes('___');
                }).raise();
            }

            function handleMouseOut(event, d) {
                textBg.transition().duration(300)
                    .style("opacity", 0)
                    .on("end", function () { textBg.style("display", "none"); });
                text.transition().duration(300).style("font-size", "14px").style("fill", "lightblue");
            }
        }
    }
</script>
<footer class="container">
  <div class="row">
    <div class="col-sm-12 text-left" style="margin-top: 20px; font-size: 12px; color: #555;">
      (c) Newcastle University - Dr. Maxim Kolomeets (<a href="http://www.kmax.science" target="_blank" style="color: inherit; text-decoration: none;">www.kmax.science</a>)
    </div>
  </div>
</footer>

</body>
</html>
