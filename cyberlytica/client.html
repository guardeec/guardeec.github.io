<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cyberlytica • Privacy Risks Explorer</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    :root{
      --bg-main:#0f1115;      /* общий фон */
      --surface-1:#171a21;    /* карточки */
      --surface-2:#13161b;    /* панели */
      --txt:#e6e7ea;
      --muted:#a9afbf;
      --brand-1:#66a6ff;
      --brand-2:#89f7fe;
      --btn:#2b2f39;
      --btn-active:#3d6be8;
      --chip-low:#5c6b7a;
      --chip-med:#ffb300;
      --chip-high:#e53935;
    }
    *{box-sizing:border-box; font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";}
    body{margin:0; background:var(--bg-main); color:var(--txt);}

    /* ===== Brand header (no separators) ===== */
    header#brandBar{position:sticky; top:0; z-index:60; background:linear-gradient(180deg, rgba(138,180,255,.10), rgba(137,247,254,.06) 35%, rgba(0,0,0,0) 100%);}
    .brand-inner{max-width:1280px; margin:0 auto; padding:28px 20px 18px;}
    .brand-title{font-family:'Russo One', system-ui; letter-spacing:.5px; font-size:44px; line-height:1; background:linear-gradient(90deg, var(--brand-1), var(--brand-2)); -webkit-background-clip:text; background-clip:text; color:transparent;}
    .brand-sub{margin-top:6px; color:var(--muted); font-size:13px;}

    /* ===== Search (no borders) ===== */
    #searchBar{ position:sticky; top:98px; z-index:50; background:transparent; padding:10px 20px 0; display:flex; justify-content:center; }
    .search-wrap{ width:min(1000px, 96vw); position:relative; }
    #searchInput{ width:100%; padding:14px 16px; border:none; outline:none; border-radius:14px; background:var(--surface-2); color:var(--txt); font-size:15px; box-shadow:0 0 0 1px rgba(255,255,255,.06) inset, 0 10px 30px rgba(0,0,0,.35); }
    #suggestions{ position:absolute; top:calc(100% + 8px); left:0; right:0; background:var(--surface-1); border:none; border-radius:14px; box-shadow:0 18px 44px rgba(0,0,0,.55); max-height:360px; overflow:auto; display:none; z-index:55; }
    .sugg-item{ padding:11px 14px; display:flex; justify-content:space-between; gap:12px; cursor:pointer; }
    .sugg-item:hover{ background:#1b2029; }
    .sugg-name{ font-size:14px; }
    .sugg-id{ font-size:12px; opacity:.7; }

    /* ===== App header (no borders) ===== */
    #appHeader{ display:none; max-width:min(1180px, 96vw); margin:18px auto 6px; padding:16px; background:var(--surface-1); border-radius:18px; box-shadow:0 14px 40px rgba(0,0,0,.45); }
    .app-row{ display:flex; gap:16px; align-items:flex-start; }
    .app-icon{ width:92px; height:92px; border-radius:22px; flex:0 0 92px; background:#0d0e10; overflow:hidden; display:grid; place-items:center; box-shadow:0 0 0 1px rgba(255,255,255,.05) inset; }
    .app-icon img{ width:100%; height:100%; object-fit:cover; display:block; }
    .app-meta{ flex:1 1 auto; min-width:0; }
    .app-name{ font-weight:800; font-size:22px; margin:0 0 8px; letter-spacing:.2px; }
    .app-desc{ font-size:15px; opacity:.92; margin:0 0 10px; display:-webkit-box; -webkit-line-clamp:8; -webkit-box-orient:vertical; overflow:hidden; }
    .app-extra{ font-size:12px; color:var(--muted); display:flex; gap:12px; flex-wrap:wrap; }

    /* ===== Controls (minimal, floating) ===== */
    #controls{ position:sticky; top:178px; z-index:40; display:flex; justify-content:center; gap:10px; padding:10px 16px; background:transparent; }
    #controls button{ padding:10px 18px; border:none; border-radius:12px; background:var(--btn); color:var(--txt); font-size:14px; cursor:pointer; transition:transform .15s ease, background .25s ease, box-shadow .25s ease; box-shadow:0 1px 0 rgba(255,255,255,.05) inset, 0 6px 18px rgba(0,0,0,.35); }
    #controls button:hover{ transform:translateY(-1px); }
    #controls button.active{ background:var(--btn-active); color:#fff; box-shadow:0 10px 24px rgba(61,107,232,.35); }

    /* ===== Groups (risk borders остаются) ===== */
    #groups{ column-width:340px; column-gap:18px; padding:14px 20px 80px; max-width:min(1180px, 96vw); margin:0 auto; }
    .group{ display:inline-block; width:100%; margin:0 0 18px; background:var(--surface-1); border-radius:16px; padding:16px; box-shadow:0 10px 26px rgba(0,0,0,.45); }
    .group-title{ font-weight:700; margin-bottom:10px; font-size:15px; }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; }

    .chip{ display:inline-block; padding:6px 12px; border-radius:999px; font-size:12px; line-height:1.15; white-space:nowrap; color:#fff; letter-spacing:.02em; transition:transform .25s, filter .25s, box-shadow .25s; cursor:default; position:relative; }
    .chip:hover{ transform:translateY(-3px) scale(1.06); box-shadow:0 4px 10px rgba(0,0,0,.6); filter:brightness(1.12); }
    .risk-low{ background:var(--chip-low); box-shadow:0 0 0 1px rgba(255,255,255,.04) inset; }
    .risk-medium{ background:var(--chip-med); color:#000; box-shadow:0 0 0 1px rgba(0,0,0,.08) inset; }
    .risk-high{ background:var(--chip-high); box-shadow:0 0 0 1px rgba(0,0,0,.15) inset; }
    .border-low{ box-shadow:0 0 0 2px var(--chip-low) inset, 0 10px 24px rgba(0,0,0,.35); }
    .border-medium{ box-shadow:0 0 0 2px var(--chip-med) inset, 0 10px 24px rgba(0,0,0,.35); }
    .border-high{ box-shadow:0 0 0 2px var(--chip-high) inset, 0 10px 24px rgba(0,0,0,.35); }

    /* Tooltip */
    #tooltip{ position:fixed; max-width:320px; padding:10px 12px; font-size:12px; border-radius:8px; background:#2b2f39; color:#fff; pointer-events:none; opacity:0; transition:opacity .15s ease; z-index:100; box-shadow:0 10px 24px rgba(0,0,0,.55); }

    /* Gate */
    #gate{ position:fixed; inset:0; display:grid; place-items:center; background:rgba(5,7,10,.6); backdrop-filter:blur(3px); z-index:999; }
    #gateCard{ background:var(--surface-1); padding:22px; border-radius:16px; min-width:320px; box-shadow:0 18px 44px rgba(0,0,0,.6); }
    #gateCard h3{ margin:0 0 12px; }
    #gateForm input{ width:100%; padding:10px; border:none; border-radius:10px; background:var(--surface-2); color:var(--txt); margin-bottom:12px; box-shadow:0 0 0 1px rgba(255,255,255,.06) inset; }
    #gateBtn{ width:100%; padding:10px; border:none; border-radius:10px; background:var(--btn-active); color:#fff; cursor:pointer; }
    #gateErr{ color:#e53935; margin-top:10px; font-size:12px; min-height:16px; }

    @media (max-width:700px){
      .brand-title{font-size:34px}
      #controls{top:170px}
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Brand header -->
  <header id="brandBar">
    <div class="brand-inner">
      <div class="brand-title">Cyberlytica</div>
      <div class="brand-sub">Privacy Risks Explorer</div>
    </div>
  </header>

  <!-- Search -->
  <div id="searchBar">
    <div class="search-wrap">
      <input id="searchInput" type="text" placeholder="Search app… (focus to see latest 10)" autocomplete="off"/>
      <div id="suggestions"></div>
    </div>
  </div>

  <!-- App header (icon + meta) -->
  <section id="appHeader"></section>

  <!-- Mode controls -->
  <div id="controls">
    <button data-mode="category" class="active">Data Classes</button>
    <button data-mode="purpose">Purposes</button>
    <button data-mode="sharing">Sharing</button>
    <button data-mode="processing">Processing</button>
  </div>

  <!-- Viz -->
  <main id="groups"></main>
  <div id="tooltip"></div>

  <!-- Password gate -->
  <div id="gate">
    <div id="gateCard">
      <h3>Enter access password</h3>
      <form id="gateForm">
        <input id="gatePass" type="password" placeholder="Password" required/>
        <button id="gateBtn" type="submit">Continue</button>
        <div id="gateErr"></div>
      </form>
    </div>
  </div>

  <!-- Firebase + App code -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, getDoc, query, orderBy, limit, startAt, endAt } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCOsjAtEaNLpMtTMTFjY6CylzfvhHrFjfo",
      authDomain: "poli-db.firebaseapp.com",
      projectId: "poli-db",
      storageBucket: "poli-db.firebasestorage.app",
      messagingSenderId: "515718309045",
      appId: "1:515718309045:web:9806f377bf7b48ef758afc",
      measurementId: "G-SL0SS8G23G"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const VIEWER_EMAIL = "tester@cyberlytica.ai";

    // UI refs
    const gate      = document.getElementById('gate');
    const gateForm  = document.getElementById('gateForm');
    const gatePass  = document.getElementById('gatePass');
    const gateErr   = document.getElementById('gateErr');

    const searchInput = document.getElementById('searchInput');
    const suggestions = document.getElementById('suggestions');

    const appHeaderEl = document.getElementById('appHeader');
    const groupsEl    = document.getElementById('groups');
    const tooltip     = document.getElementById('tooltip');

    let ontology = null;
    let viz = null;

    /* ===== Auth ===== */
    gateForm.addEventListener('submit', async (e)=>{
      e.preventDefault(); gateErr.textContent='';
      try{ await signInWithEmailAndPassword(auth, VIEWER_EMAIL, gatePass.value); }
      catch(err){ console.error(err); gateErr.textContent = err?.message || 'Auth failed'; }
    });

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ gate.style.display='grid'; return; }
      gate.style.display='none';
      try{ ontology = ontology || await fetchOntology(); }catch(e){ console.error('Ontology load failed', e); }
    });

    /* ===== Search & suggestions ===== */
    function escapeHtml(s=''){ return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }
    function fixMojibake(s=''){ try{ const x=decodeURIComponent(escape(s)); return x || s; }catch{ return s; } }

    async function fetchLatest10(){
      const qRef = query(collection(db,'Apps'), orderBy('scraped_at','desc'), limit(10));
      const snap = await getDocs(qRef);
      return snap.docs.map(d=>({ id:d.id, ...(d.data()||{}) }));
    }
    async function searchByNameLike(qstr){
      if(!qstr) return [];
      const qRef = query(collection(db,'Apps'), orderBy('name'), startAt(qstr), endAt(qstr+'\uf8ff'), limit(10));
      const snap = await getDocs(qRef);
      return snap.docs.map(d=>({ id:d.id, ...(d.data()||{}) }));
    }

    function showSuggestions(items){
      suggestions.innerHTML='';
      if(!items || !items.length){ suggestions.style.display='none'; return; }
      items.forEach(it=>{
        const div=document.createElement('div');
        div.className='sugg-item';
        div.innerHTML = `
          <div class="sugg-name">${escapeHtml(fixMojibake(it.name || '(no name)'))}</div>
          <div class="sugg-id">${it.id}</div>`;
        div.addEventListener('click', async ()=>{
          suggestions.style.display='none';
          searchInput.value = fixMojibake(it.name || '');
          await loadAndRenderApp(it.id);
        });
        suggestions.appendChild(div);
      });
      suggestions.style.display='block';
    }

    searchInput.addEventListener('focus', async ()=>{ try{ showSuggestions(await fetchLatest10()); }catch(e){ console.error(e); } });
    const debounced=(fn,ms=250)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); } };
    searchInput.addEventListener('input', debounced(async (e)=>{
      const q=e.target.value.trim();
      try{ if(!q) showSuggestions(await fetchLatest10()); else showSuggestions(await searchByNameLike(q)); }
      catch(err){ console.error(err); }
    }, 300));
    document.addEventListener('click',(e)=>{ if(!document.querySelector('.search-wrap').contains(e.target)) suggestions.style.display='none'; });

    /* ===== App load + header render + viz ===== */
    async function loadAndRenderApp(appId){
      try{
        const snap = await getDoc(doc(db,'Apps', String(appId)));
        if(!snap.exists()){ alert('App not found'); return; }
        const data = snap.data()||{};
        const raw  = extractRawFromPrivacy(data.privacy);
        const iconUrl = data.icon_url || await fetchAppIcon(appId).catch(()=>null);
        renderAppHeader({ id:appId, name:data.name||'(no name)', description:data.description||'', scraped_at:data.scraped_at||null, icon:iconUrl });
        if(!raw){ alert('privacy data not found in document'); return; }
        viz = viz || createViz(ontology);
        viz.update(raw);
      }catch(err){ console.error(err); alert('Failed to load app data'); }
    }

    function renderAppHeader({id,name,description,scraped_at,icon}){
      const when = formatTs(scraped_at);
      const iconHtml = icon ? `<img src="${icon}" alt="${escapeHtml(name)} icon" loading="lazy"/>` : `<span style="font-size:26px; opacity:.6;">📱</span>`;
      appHeaderEl.innerHTML = `
        <div class="app-row">
          <div class="app-icon">${iconHtml}</div>
          <div class="app-meta">
            <h2 class="app-name">${escapeHtml(fixMojibake(name))}</h2>
            <p class="app-desc">${escapeHtml(fixMojibake(description||''))}</p>
            <div class="app-extra">
              <span>App ID: <code>${escapeHtml(String(id))}</code></span>
              <span>Scanned: ${escapeHtml(when)}</span>
            </div>
          </div>
        </div>`;
      appHeaderEl.style.display='block';
    }

    function formatTs(ts){
      try{ let d = ts?.toDate ? ts.toDate() : (ts?.seconds ? new Date(ts.seconds*1000) : (ts ? new Date(ts) : null)); if(!d || isNaN(+d)) return '—'; return d.toLocaleString(); }catch{ return '—'; }
    }

    async function fetchAppIcon(appId){
      const r = await fetch(`https://itunes.apple.com/lookup?id=${encodeURIComponent(appId)}`);
      const j = await r.json();
      const it = j?.results?.[0];
      return it?.artworkUrl512 || it?.artworkUrl100 || null;
    }

    async function fetchOntology(){
      const r = await fetch('ontology/ontology.json');
      return await r.json();
    }

    function extractRawFromPrivacy(privacy){
      if(Array.isArray(privacy)) return privacy;
      if(privacy && Array.isArray(privacy.items)) return privacy.items;
      if(privacy && Array.isArray(privacy.extractions)) return privacy.extractions;
      return null;
    }

    /* ===== Visualization ===== */
    function createViz(ontology){
      const catByType={}, riskByType={};
      (ontology['Data Collection']||[]).forEach(r=>{ catByType[r['Example']] = r['Subcategory']||r['Category']; riskByType[r['Example']] = r['Risk Level']||'Low'; });
      const riskByPurpose={}, riskByShare={}, riskByProcess={};
      (ontology['Purpose']||[]).forEach(r=>{ riskByPurpose[r['Subcategory']||r['Category']] = r['Risk']; });
      (ontology['With whom Shared']||[]).forEach(r=>{ riskByShare[r['Subcategory']||r['Category']] = r['Risk']; });
      (ontology['How its Processed']||[]).forEach(r=>{ const cls=r['Risk Subcategories']||''; riskByProcess[r['Attribute']] = cls.includes('High')?'High':(cls.includes('Medium')?'Medium':'Low'); });

      const QUOTE_KEY={ category:'collection_quote', purpose:'purpose_quote', sharing:'sharing_quote', processing:'processing_quote' };
      const MODES={
        category:{ key:'categories',  risk:()=>null },
        purpose:{  key:'purposes',    risk:n=>riskByPurpose[n]||null },
        sharing:{  key:'sharing',     risk:n=>riskByShare[n]  ||null },
        processing:{ key:'processing',risk:n=>riskByProcess[n]||null }
      };

      let mode='category';
      document.querySelectorAll('#controls button').forEach(btn=>{
        btn.addEventListener('click',()=>{ mode = btn.dataset.mode; document.querySelectorAll('#controls button').forEach(b=>b.classList.toggle('active', b===btn)); render(); });
      });

      const chipPool=new Map();
      function ensureChip(type, risk, idx, quote){
        const key=`${type}::${idx}`; let span=chipPool.get(key);
        if(!span){ span=document.createElement('span'); span.className=`chip risk-${(risk||'Low').toLowerCase()}`; span.textContent=type; chipPool.set(key,span);
          span.addEventListener('mouseenter',()=>{ if(!span.dataset.quote){ tooltip.style.opacity=0; return; } tooltip.textContent=span.dataset.quote; const rect=span.getBoundingClientRect(); tooltip.style.left=`${rect.left + rect.width/2}px`; tooltip.style.top=`${rect.top - 10}px`; tooltip.style.opacity=1; });
          span.addEventListener('mouseleave',()=>{ tooltip.style.opacity=0; });
        }
        span.className=`chip risk-${(risk||'Low').toLowerCase()}`; span.dataset.quote=quote||''; return span;
      }

      function snapshot(){ return new Map([...chipPool.values()].map(el=>[el, el.getBoundingClientRect()])); }
      function runFLIP(prev){ chipPool.forEach(span=>{ const first=prev.get(span); if(!first) return; const last=span.getBoundingClientRect(); const dx=first.left-last.left, dy=first.top-last.top; if(dx||dy) span.animate([{transform:`translate(${dx}px,${dy}px)`},{transform:'translate(0,0)'}], { duration:600, easing:'ease-out' }); }); }

      let records=[];
      function normalizeRaw(raw){ return raw.map(r=>({ type:r.type, categories:[catByType[r.type]||'Unspecified'], purposes:Array.isArray(r.purposes)&&r.purposes.length?r.purposes:['Unspecified'], sharing:Array.isArray(r.shared_with)&&r.shared_with.length?r.shared_with:['Unspecified'], processing:Array.isArray(r.processing)&&r.processing.length?r.processing:['Unspecified'], risk:riskByType[r.type]||'Low', collection_quote:r.collection_quote||r.collectionQuote||'', purpose_quote:r.purpose_quote||r.purposeQuote||'', sharing_quote:r.sharing_quote||r.sharingQuote||'', processing_quote:r.processing_quote||r.processingQuote||'' })); }

      function buildGroups(){ const map=new Map(); records.forEach(rec=>{ rec[MODES[mode].key].forEach(parent=>{ if(!map.has(parent)) map.set(parent,[]); map.get(parent).push(rec); }); }); return Array.from(map, ([name,items])=>({ name, items })); }

      function render(){ if(!records.length){ groupsEl.innerHTML=''; return; } const groups=buildGroups(); const prev=snapshot(); const used=new Set(); groupsEl.innerHTML='';
        const needCount={}; groups.forEach(g=>g.items.forEach(rec=>{ needCount[rec.type]=(needCount[rec.type]||0)+1; })); Object.entries(needCount).forEach(([type,count])=>{ const defRisk=riskByType[type]||'Low'; for(let i=1;i<=count;i++) ensureChip(type, defRisk, i, ''); });
        const indexMap={}; groups.forEach(g=>{ let gRisk = MODES[mode].risk(g.name) || (g.items.some(r=>r.risk==='High')?'High':(g.items.some(r=>r.risk==='Medium')?'Medium':'Low')); const card=document.createElement('div'); card.className=`group border-${gRisk.toLowerCase()}`; card.innerHTML=`<div class="group-title">${g.name}</div>`; const wrap=document.createElement('div'); wrap.className='chips';
          g.items.forEach(rec=>{ indexMap[rec.type]=(indexMap[rec.type]||0)+1; const idx=indexMap[rec.type]; const quote=rec[QUOTE_KEY[mode]]||''; const chip=ensureChip(rec.type, rec.risk, idx, quote); used.add(`${rec.type}::${idx}`); wrap.appendChild(chip); });
          card.appendChild(wrap); groupsEl.appendChild(card); });
        chipPool.forEach((el,key)=>{ if(!used.has(key)) chipPool.delete(key); }); runFLIP(prev); }

      return { update(raw){ records=normalizeRaw(raw); render(); } };
    }
  </script>
</body>
</html>
